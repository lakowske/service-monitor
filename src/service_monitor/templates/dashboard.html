<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Monitor Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
</head>
<body>
    <header class="header">
        <div class="container">
            <h1 class="title">üîç Service Monitor</h1>
            <div class="header-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Services:</span>
                    <span class="stat-value">{{ total_services }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Uptime:</span>
                    <span class="stat-value">{{ "%.1f" | format(uptime_seconds / 3600) }}h</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Last Update:</span>
                    <span class="stat-value" id="last-update">Now</span>
                </div>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <!-- Status Overview -->
            <section class="status-overview">
                <h2>Status Overview</h2>
                <div class="status-grid">
                    <div class="status-card status-up">
                        <div class="status-icon">‚úÖ</div>
                        <div class="status-info">
                            <div class="status-count">{{ status_counts.up }}</div>
                            <div class="status-label">Up</div>
                        </div>
                    </div>
                    <div class="status-card status-down">
                        <div class="status-icon">‚ùå</div>
                        <div class="status-info">
                            <div class="status-count">{{ status_counts.down }}</div>
                            <div class="status-label">Down</div>
                        </div>
                    </div>
                    <div class="status-card status-degraded">
                        <div class="status-icon">‚ö†Ô∏è</div>
                        <div class="status-info">
                            <div class="status-count">{{ status_counts.degraded }}</div>
                            <div class="status-label">Degraded</div>
                        </div>
                    </div>
                    <div class="status-card status-unknown">
                        <div class="status-icon">‚ùì</div>
                        <div class="status-info">
                            <div class="status-count">{{ status_counts.unknown }}</div>
                            <div class="status-label">Unknown</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Services List -->
            <section class="services-section">
                <div class="section-header">
                    <h2>Services</h2>
                    <button class="refresh-btn" onclick="window.location.reload()">üîÑ Refresh</button>
                </div>

                {% if services %}
                <div class="services-grid">
                    {% for service in services %}
                    <div class="service-card service-{{ service.status.value }}" onclick="window.location.href='/service/{{ service.service_name | urlencode }}'">
                        <div class="service-header">
                            <h3 class="service-name">{{ service.service_name }}</h3>
                            <div class="service-header-right">
                                <div class="service-status status-{{ service.status.value }}">
                                    {% if service.status.value == 'up' %}‚úÖ{% endif %}
                                    {% if service.status.value == 'down' %}‚ùå{% endif %}
                                    {% if service.status.value == 'degraded' %}‚ö†Ô∏è{% endif %}
                                    {% if service.status.value == 'unknown' %}‚ùì{% endif %}
                                    {{ service.status.value.title() }}
                                </div>
                                <button class="delete-service-btn" onclick="event.stopPropagation(); deleteService('{{ service.service_name }}');" title="Remove service from monitoring">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                        <div class="service-info">
                            <div class="service-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Last Check:</span>
                                    <span class="meta-value">{{ service.last_check_in.strftime('%H:%M:%S') }}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Check-ins:</span>
                                    <span class="meta-value">{{ service.check_in_count }}</span>
                                </div>
                            </div>
                            {% if service.message %}
                            <div class="service-message">{{ service.message }}</div>
                            {% endif %}
                        </div>
                        <div class="service-footer">
                            <span class="click-hint">Click for details ‚Üí</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üìã</div>
                    <h3>No Services Monitored</h3>
                    <p>Services will appear here once they start checking in.</p>
                    <div class="api-hint">
                        <strong>API Endpoint:</strong> POST /services/checkin
                    </div>
                </div>
                {% endif %}
            </section>

            <!-- Notification Management -->
            <section class="notification-section">
                <div class="section-header">
                    <h2>üìß Email Notifications</h2>
                    <button class="btn-secondary" onclick="sendTestNotification()">Send Test Email</button>
                </div>

                <div class="notification-info">
                    <div class="info-card">
                        <div class="info-icon">üì¨</div>
                        <div class="info-content">
                            <div class="info-title">Auto-Alerts Enabled</div>
                            <div class="info-description">
                                Automatic emails sent when services go DOWN or DEGRADED, and when they recover.
                            </div>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon">‚è±Ô∏è</div>
                        <div class="info-content">
                            <div class="info-title">Smart Cooldown</div>
                            <div class="info-description">
                                Maximum 1 notification per service per hour to prevent spam.
                            </div>
                        </div>
                    </div>
                    <div class="info-card">
                        <div class="info-icon">üéØ</div>
                        <div class="info-content">
                            <div class="info-title">Rich Content</div>
                            <div class="info-description">
                                HTML emails with service details, metadata, and direct links to this dashboard.
                            </div>
                        </div>
                    </div>
                </div>

                <div class="notification-actions">
                    <button class="btn btn-secondary" onclick="viewNotificationHistory()">
                        üìã View History
                    </button>
                    <button class="btn btn-secondary" onclick="clearNotificationHistory()">
                        üóëÔ∏è Clear History
                    </button>
                </div>

                <div id="notification-history" class="notification-history" style="display: none;">
                    <h3>Notification History</h3>
                    <div id="history-content">
                        <!-- History will be loaded here -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-links">
                <a href="/docs" target="_blank">API Documentation</a>
                <a href="/health" target="_blank">Health Check</a>
                <a href="/" onclick="window.location.reload()">Refresh Dashboard</a>
            </div>
        </div>
    </footer>

    <script>
        // Auto-refresh every 30 seconds
        setInterval(() => {
            window.location.reload();
        }, 30000);

        // Update last update time
        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString();
        }

        // Update time every second
        setInterval(updateLastUpdateTime, 1000);
        updateLastUpdateTime();

        // Notification management functions
        async function sendTestNotification() {
            try {
                const response = await fetch('/notifications/test', { method: 'POST' });
                const result = await response.json();
                alert(result.message);
            } catch (error) {
                alert('Failed to send test notification: ' + error.message);
            }
        }

        async function viewNotificationHistory() {
            const historySection = document.getElementById('notification-history');
            const historyContent = document.getElementById('history-content');

            try {
                const response = await fetch('/notifications/history');
                const result = await response.json();

                if (result.success && Object.keys(result.history).length > 0) {
                    let html = '<div class="history-grid">';
                    for (const [serviceName, hist] of Object.entries(result.history)) {
                        const lastNotification = new Date(hist.last_notification).toLocaleString();
                        html += `
                            <div class="history-item">
                                <div class="history-service">${hist.service_name}</div>
                                <div class="history-details">
                                    <div>Status: <span class="status-${hist.last_status}">${hist.last_status.toUpperCase()}</span></div>
                                    <div>Last: ${lastNotification}</div>
                                    <div>Count: ${hist.notification_count}</div>
                                </div>
                                <button class="btn-small" onclick="clearServiceHistory('${serviceName}')">Clear</button>
                            </div>
                        `;
                    }
                    html += '</div>';
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = '<p class="empty-message">No notification history available.</p>';
                }

                historySection.style.display = historySection.style.display === 'none' ? 'block' : 'none';
            } catch (error) {
                alert('Failed to load notification history: ' + error.message);
            }
        }

        async function clearNotificationHistory() {
            if (confirm('Are you sure you want to clear all notification history?')) {
                try {
                    const response = await fetch('/notifications/history', { method: 'DELETE' });
                    const result = await response.json();
                    alert(result.message);
                    document.getElementById('notification-history').style.display = 'none';
                } catch (error) {
                    alert('Failed to clear notification history: ' + error.message);
                }
            }
        }

        async function clearServiceHistory(serviceName) {
            if (confirm(`Clear notification history for ${serviceName}?`)) {
                try {
                    const response = await fetch(`/notifications/history/${serviceName}`, { method: 'DELETE' });
                    const result = await response.json();
                    alert(result.message);
                    viewNotificationHistory(); // Refresh the view
                } catch (error) {
                    alert('Failed to clear service history: ' + error.message);
                }
            }
        }

        // Service deletion
        async function deleteService(serviceName) {
            if (confirm(`Are you sure you want to remove "${serviceName}" from monitoring?\n\nThis will delete all check-in history for this service.`)) {
                try {
                    const response = await fetch(`/services/${encodeURIComponent(serviceName)}`, { method: 'DELETE' });
                    if (response.ok) {
                        // Reload the page to show updated service list
                        window.location.reload();
                    } else {
                        const error = await response.json();
                        alert(`Failed to delete service: ${error.detail || 'Unknown error'}`);
                    }
                } catch (error) {
                    alert('Failed to delete service: ' + error.message);
                }
            }
        }
    </script>
</body>
</html>
